<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Better Recs</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 {
      margin-bottom: 8px;
    }
    .subtitle {
      color: #888;
      margin-bottom: 24px;
    }

    /* Playlist inputs */
    .playlists-container {
      margin-bottom: 16px;
    }
    .playlist-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .playlist-url {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #2a2a2a;
      color: #e0e0e0;
    }
    .playlist-url:focus {
      outline: none;
      border-color: #1db954;
    }
    .weight-control {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
    }
    .weight-input {
      width: 50px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #2a2a2a;
      color: #e0e0e0;
      text-align: center;
    }
    .weight-input:focus {
      outline: none;
      border-color: #1db954;
    }
    .remove-btn {
      padding: 8px 12px;
      font-size: 16px;
      background: #333;
      color: #888;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remove-btn:hover {
      background: #ff4444;
      color: white;
    }
    .remove-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .remove-btn:disabled:hover {
      background: #333;
      color: #888;
    }

    /* Buttons */
    .button-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #1db954;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1ed760;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .add-btn {
      background: #333;
      color: #e0e0e0;
    }
    .add-btn:hover {
      background: #444;
    }

    /* Status messages */
    .error {
      background: #ff4444;
      color: white;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* Results */
    .results {
      margin-top: 24px;
    }
    .seed-artists {
      background: #2a2a2a;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 24px;
    }
    .seed-artists h3 {
      margin-top: 0;
      color: #888;
    }
    .seed-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .seed-tag {
      background: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 14px;
    }
    .recommendations h2 {
      margin-bottom: 16px;
    }
    .rec-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #333;
    }
    .rec-item:hover {
      background: #2a2a2a;
    }
    .rec-name {
      font-size: 16px;
    }
    .rec-stats {
      display: flex;
      gap: 16px;
      color: #888;
      font-size: 14px;
    }
    .rec-rank {
      color: #555;
      margin-right: 12px;
      min-width: 24px;
    }
    .spotify-link {
      color: #1db954;
      text-decoration: none;
      margin-left: 8px;
    }
    .spotify-link:hover {
      text-decoration: underline;
    }
    .weight-summary {
      color: #888;
      font-size: 14px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <h1>Better Recs</h1>
  <p class="subtitle">Music recommendations powered by Last.fm's collaborative filtering</p>

  <form id="playlist-form">
    <div id="playlists-container" class="playlists-container">
      <!-- Playlist rows will be added here dynamically -->
    </div>

    <div class="button-row">
      <button type="button" id="add-btn" class="add-btn">+ Add Playlist</button>
      <button type="submit" id="submit-btn">Get Recommendations</button>
    </div>
  </form>

  <div id="error" class="error" style="display: none;"></div>
  <div id="loading" class="loading" style="display: none;">Finding recommendations...</div>
  <div id="results" class="results" style="display: none;"></div>

  <script>
    const form = document.getElementById('playlist-form');
    const container = document.getElementById('playlists-container');
    const addBtn = document.getElementById('add-btn');
    const submitBtn = document.getElementById('submit-btn');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');

    let playlistCount = 0;

    // Initialize with one playlist input
    addPlaylistRow();

    addBtn.addEventListener('click', () => {
      addPlaylistRow();
    });

    function addPlaylistRow() {
      playlistCount++;
      const row = document.createElement('div');
      row.className = 'playlist-row';
      row.dataset.id = playlistCount;

      const numPlaylists = container.children.length + 1;
      const defaultWeight = Math.round(100 / numPlaylists);

      row.innerHTML = `
        <input
          type="text"
          class="playlist-url"
          placeholder="Paste a Spotify playlist URL..."
          required
        >
        <div class="weight-control">
          <input
            type="number"
            class="weight-input"
            value="${defaultWeight}"
            min="1"
            max="100"
          >
          <span>%</span>
        </div>
        <button type="button" class="remove-btn" title="Remove playlist">Ã—</button>
      `;

      container.appendChild(row);
      redistributeWeights();
      updateRemoveButtons();

      // Add event listeners
      const removeBtn = row.querySelector('.remove-btn');
      removeBtn.addEventListener('click', () => {
        row.remove();
        redistributeWeights();
        updateRemoveButtons();
      });

      const weightInput = row.querySelector('.weight-input');
      weightInput.addEventListener('change', () => {
        balanceWeights(row);
      });
    }

    function redistributeWeights() {
      const rows = container.querySelectorAll('.playlist-row');
      const equalWeight = Math.round(100 / rows.length);
      let remainder = 100 - (equalWeight * rows.length);

      rows.forEach((row, i) => {
        const input = row.querySelector('.weight-input');
        // Give the remainder to the first playlist
        input.value = i === 0 ? equalWeight + remainder : equalWeight;
      });
    }

    function balanceWeights(changedRow) {
      const rows = Array.from(container.querySelectorAll('.playlist-row'));
      const otherRows = rows.filter(r => r !== changedRow);

      if (otherRows.length === 0) {
        // Only one playlist, force it to 100
        changedRow.querySelector('.weight-input').value = 100;
        return;
      }

      const changedWeight = parseInt(changedRow.querySelector('.weight-input').value) || 0;
      const clampedWeight = Math.min(99, Math.max(1, changedWeight));
      changedRow.querySelector('.weight-input').value = clampedWeight;

      const remainingWeight = 100 - clampedWeight;
      const weightPerOther = Math.floor(remainingWeight / otherRows.length);
      let remainder = remainingWeight - (weightPerOther * otherRows.length);

      otherRows.forEach((row, i) => {
        const input = row.querySelector('.weight-input');
        input.value = i === 0 ? weightPerOther + remainder : weightPerOther;
      });
    }

    function updateRemoveButtons() {
      const rows = container.querySelectorAll('.playlist-row');
      const removeButtons = container.querySelectorAll('.remove-btn');

      removeButtons.forEach(btn => {
        btn.disabled = rows.length <= 1;
      });
    }

    function getPlaylists() {
      const rows = container.querySelectorAll('.playlist-row');
      const playlists = [];

      rows.forEach(row => {
        const url = row.querySelector('.playlist-url').value.trim();
        const weight = parseInt(row.querySelector('.weight-input').value) || 0;

        if (url) {
          playlists.push({ url, weight });
        }
      });

      return playlists;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const playlists = getPlaylists();
      if (playlists.length === 0) return;

      // Reset UI
      errorDiv.style.display = 'none';
      resultsDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;

      try {
        // Use single endpoint for 1 playlist, multiple for more
        let response, data;

        if (playlists.length === 1) {
          response = await fetch('/api/recommendations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playlistUrl: playlists[0].url }),
          });
        } else {
          response = await fetch('/api/recommendations/multiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playlists }),
          });
        }

        data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to get recommendations');
        }

        displayResults(data, playlists);
      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
      } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    function displayResults(data, inputPlaylists) {
      const { seedArtists, recommendations, totalFound, playlistWeights } = data;

      // Show weight summary for multiple playlists
      let weightSummary = '';
      if (inputPlaylists.length > 1) {
        weightSummary = `
          <div class="weight-summary">
            Playlist weights: ${inputPlaylists.map((p, i) => `Playlist ${i + 1}: ${p.weight}%`).join(' | ')}
          </div>
        `;
      }

      let html = `
        <div class="seed-artists">
          <h3>Seed Artists (${seedArtists.length})</h3>
          ${weightSummary}
          <div class="seed-list">
            ${seedArtists.map(a => `<span class="seed-tag">${escapeHtml(a.name)}</span>`).join('')}
          </div>
        </div>

        <div class="recommendations">
          <h2>Recommendations</h2>
          <p style="color: #888; margin-bottom: 16px;">Found ${totalFound} similar artists. Showing top ${recommendations.length}.</p>
          ${recommendations.map((rec, i) => `
            <div class="rec-item">
              <div>
                <span class="rec-rank">${i + 1}.</span>
                <span class="rec-name">${escapeHtml(rec.name)}</span>
                <a class="spotify-link" href="https://open.spotify.com/search/${encodeURIComponent(rec.name)}" target="_blank">Open in Spotify</a>
              </div>
              <div class="rec-stats">
                <span title="Similar to this many seed artists">freq: ${rec.frequency}</span>
                <span title="Average similarity score">match: ${rec.averageMatch.toFixed(2)}</span>
                <span title="Weighted score">score: ${rec.combinedScore.toFixed(2)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      resultsDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
